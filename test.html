<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T·ª´ ƒêi·ªÉn H√°n Ng·ªØ Flashcard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --primary: #00a86b; --secondary: #1a5fb4; --bg: #f2f2f7; --text: #2c3e50; }
        body { margin: 0; font-family: sans-serif; background-color: var(--bg); color: var(--text); overflow: hidden; }
        
        #book { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; }
        .flashcard { scroll-snap-align: start; min-height: 100vh; width: 100%; padding: 20px 20px 120px 20px; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; }

        /* Giao di·ªán ch√≠nh */
        .header-section { background: white; border: 2px solid var(--primary); border-radius: 20px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .big-char { font-size: 80px; font-weight: bold; margin: 0; line-height: 1; }
        .info-top { text-align: right; flex: 1; }
        .pinyin-text { font-size: 24px; color: var(--primary); font-weight: bold; }
        .han-viet { font-size: 20px; color: var(--secondary); font-weight: bold; }

        .section-title { display: flex; align-items: center; justify-content: space-between; font-weight: bold; color: var(--secondary); margin-top: 5px; }
        .component-box { background: white; border-left: 6px solid #ff9f43; border-radius: 12px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Khu v·ª±c SVG Th·ª© t·ª± n√©t */
        .stroke-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; background: white; padding: 10px; border-radius: 15px; min-height: 100px; }
        .stroke-container { position: relative; width: 100%; aspect-ratio: 1/1; border: 1px solid #f9f9f9; display: flex; align-items: center; justify-content: center; }
        .stroke-container svg { width: 90%; height: 90%; transform: scaleY(-1); } /* Makemeahanzi SVG th∆∞·ªùng b·ªã ng∆∞·ª£c tr·ª•c Y */
        
        /* Hi·ªáu ·ª©ng v·∫Ω n√©t */
        .stroke-path { stroke: #333; stroke-width: 30; fill: none; stroke-linecap: round; stroke-linejoin: round; }

        /* N√∫t Replay */
        .btn-replay { background: var(--secondary); color: white; border: none; padding: 4px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-replay:active { opacity: 0.7; }

        /* Slider Navigation */
        .nav-control { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 40px; display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 9999; }
        .nav-btn { background: none; border: none; font-size: 20px; cursor: pointer; }
        .dot { width: 8px; height: 8px; background: #ddd; border-radius: 50%; transition: 0.3s; }
        .dot.active { background: var(--primary); width: 22px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="book"></div>

<div class="nav-control">
    <button class="nav-btn" onclick="prevPage()">‚Üê</button>
    <div id="pageDots" class="dots" style="display:flex; gap:6px;"></div>
    <button class="nav-btn" onclick="nextPage()">‚Üí</button>
</div>

<script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZTDVNcUri3PK3TkRuafajK9Vj8pyPKF79H6JYCzu1l56OM-xbgO7bWdcR84o_FJ8FUXuNe0ALyd7r/pub?output=csv';
    let currentIndex = 0;
    let totalItems = 0;
    const svgCache = new Map(); // B·ªô nh·ªõ ƒë·ªám ƒë·ªÉ load c·ª±c nhanh

    async function fetchSVG(url) {
        if (svgCache.has(url)) return svgCache.get(url);
        try {
            const res = await fetch(url);
            const text = await res.text();
            svgCache.set(url, text);
            return text;
        } catch (e) { return null; }
    }

    async function replayStrokes(containerId, linksStr) {
        const links = linksStr.split(', ');
        const grid = document.getElementById(containerId);
        grid.innerHTML = ''; // X√≥a ƒëi ƒë·ªÉ ch·∫°y l·∫°i

        for (const link of links) {
            const svgText = await fetchSVG(link.trim());
            if (svgText) {
                const wrapper = document.createElement('div');
                wrapper.className = 'stroke-container';
                wrapper.innerHTML = svgText;
                
                // Hi·ªáu ·ª©ng animation ƒë∆°n gi·∫£n cho n√©t v·∫Ω
                const paths = wrapper.querySelectorAll('path');
                paths.forEach((path, i) => {
                    const length = path.getTotalLength();
                    path.style.strokeDasharray = length;
                    path.style.strokeDashoffset = length;
                    path.style.transition = `stroke-dashoffset 0.5s ease-in-out ${i * 0.5}s`;
                    setTimeout(() => { path.style.strokeDashoffset = '0'; }, 100);
                });
                
                grid.appendChild(wrapper);
            }
        }
    }

    function init() {
        Papa.parse(sheetUrl, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                totalItems = results.data.length;
                render(results.data);
                createDots(totalItems);
            }
        });
    }

    function render(data) {
        const book = document.getElementById('book');
        book.innerHTML = data.map((item, index) => `
            <div class="flashcard" id="card-${index}">
                <div class="header-section">
                    <h1 class="big-char">${item['T·ª´ ti·∫øng Trung'] || ''}</h1>
                    <div class="info-top">
                        <div class="pinyin-text">${item['Pinyin'] || ''} <button style="border:none;background:none;cursor:pointer" onclick="speak('${item['T·ª´ ti·∫øng Trung']}')">üîä</button></div>
                        <div class="han-viet">H√°n Vi·ªát: ${item['Nghƒ©a ti·∫øng Vi·ªát'] || ''}</div>
                    </div>
                </div>

                <div class="section-title">
                    <span>‚úçÔ∏è Th·ª© t·ª± n√©t vi·∫øt</span>
                    <button class="btn-replay" onclick="replayStrokes('grid-${index}', '${item['GIF Th·ª© t·ª± n√©t']}')">üîÑ Xem l·∫°i</button>
                </div>
                <div class="stroke-grid" id="grid-${index}">
                    <p style="grid-column: span 2; font-size:12px; color:#999; text-align:center;">B·∫•m "Xem l·∫°i" ƒë·ªÉ t·∫£i n√©t v·∫Ω</p>
                </div>

                <div class="section-title">üë£ Th√†nh ph·∫ßn c·∫•u t·∫°o</div>
                <div class="component-box">
                    <strong>${item['Th√†nh ph·∫ßn c·∫•u t·∫°o (B·ªô th·ªß)'] || ''}</strong>
                    <div style="font-size:13px; color:#666; margin-top:5px;">${item['Ph√¢n t√≠ch k·ªπ h∆°n c·∫•u t·∫°o'] || ''}</div>
                </div>

                <div style="background:#e1f5fe; color:var(--primary); text-align:center; padding:10px; border-radius:10px; font-weight:bold;">T·ªîNG C·ªòNG: ${item['T·ªïng s·ªë n√©t'] || '0'} N√âT</div>
                
                <div style="background:white; padding:15px; border-radius:15px; font-size:13px; line-height:1.6">
                    <strong style="color:#f39c12">üí° M·∫πo ghi nh·ªõ:</strong> ${item['M·∫πo nh·ªõ'] || ''}
                </div>
            </div>
        `).join('');

        // T·ª± ƒë·ªông ch·∫°y n√©t cho trang ƒë·∫ßu ti√™n
        if (data[0]) replayStrokes('grid-0', data[0]['GIF Th·ª© t·ª± n√©t']);
    }

    // C√°c h√†m Navigation (Dots, Next, Prev) gi·ªØ nguy√™n nh∆∞ b·∫£n tr∆∞·ªõc...
    function createDots(count) {
        const container = document.getElementById('pageDots');
        for (let i = 0; i < Math.min(count, 5); i++) {
            const d = document.createElement('div');
            d.className = 'dot' + (i === 0 ? ' active' : '');
            container.appendChild(d);
        }
    }

    function updateDots(index) {
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => d.classList.toggle('active', i === (index % dots.length)));
    }

    function nextPage() { if (currentIndex < totalItems - 1) { currentIndex++; scrollToIndex(); } }
    function prevPage() { if (currentIndex > 0) { currentIndex--; scrollToIndex(); } }
    
    function scrollToIndex() {
        const card = document.getElementById(`card-${currentIndex}`);
        card.scrollIntoView();
        // Khi chuy·ªÉn trang, t·ª± ƒë·ªông load/ch·∫°y n√©t c·ªßa trang ƒë√≥
        const gridId = `grid-${currentIndex}`;
        const links = document.querySelector(`#card-${currentIndex} .btn-replay`).getAttribute('onclick').match(/'([^']+)'/g)[1].replace(/'/g, '');
        replayStrokes(gridId, links);
    }

    document.getElementById('book').addEventListener('scroll', () => {
        const index = Math.round(document.getElementById('book').scrollTop / window.innerHeight);
        if (index !== currentIndex) {
            currentIndex = index;
            updateDots(currentIndex);
        }
    });

    function speak(text) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'zh-CN';
        window.speechSynthesis.speak(utter);
    }

    init();
</script>
</body>
</html>
